<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starry Night</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .star {
            position: absolute;
            width: 20px;
            height: 20px;
            background-image: url('star.png');
            background-size: cover;
            transition: transform 0.3s ease; /* Smooth transition */
        }
    </style>
</head>
<body>
    <audio id="hoverSound" src="SFX/hover-sound.mp3" preload="auto"></audio>
    <audio id="clickSound" src="SFX/click-sound.mp3" preload="auto"></audio>
    <audio id="backgroundMusic" src="SFX/astral-music.mp3" preload="auto" loop autoplay></audio>

    <canvas id="cursorCanvas"></canvas>

    <div class="navbar">
        <a href="play.html" class="nav-button">Play</a>
        <a href="inventory.html" class="nav-button">Inventory</a>
        <a href="stats.html" class="nav-button">Stats</a>
    </div>

    <div id="popup" class="popup">
        Star Info: This is a placeholder for star information.
        <button class="close-btn" onclick="closePopup()">Close</button>
    </div>

    <div id="muteToggle" class="mute-icon" onclick="toggleMute()"></div>

    <script>
        const canvas = document.getElementById('cursorCanvas');
        const ctx = canvas.getContext('2d');
        const trail = [];
        const trailDuration = 500; // Trail duration in milliseconds
        const shootingStars = [];
        const dots = [];
        const stars = [];
        let isMuted = false;
        const maxTrailLength = 20; // Maximum number of points in the trail

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function drawTrail() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#FFD700';
            const now = Date.now();
            trail.forEach((point, index) => {
                if (now - point.time > trailDuration || index >= maxTrailLength) {
                    trail.splice(index, 1);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            });
            ctx.stroke();
        }

        function updateTrail() {
            drawTrail();
        }

        function createShootingStar() {
            const angle = Math.random() * Math.PI * 2; // Random angle
            const speed = Math.random() * 3 + 2; // Random speed
            const star = {
                x: Math.random() * window.innerWidth,
                y: Math.random() * window.innerHeight,
                speedX: Math.cos(angle) * speed,
                speedY: Math.sin(angle) * speed,
                trail: []
            };
            shootingStars.push(star);
        }

        function drawShootingStars() {
            shootingStars.forEach((star, index) => {
                // Draw the star using star.png
                const img = new Image();
                img.src = 'Images/star.png'; // Updated path
                img.onload = () => {
                    ctx.drawImage(img, star.x, star.y, 15, 15); // Increase size to 15x15
                };

                // Update star position
                star.x += star.speedX;
                star.y += star.speedY;

                // Add current position to trail
                star.trail.push({ x: star.x, y: star.y });

                // Draw the trail
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                star.trail.forEach((trailPoint, trailIndex) => {
                    if (trailIndex === 0) {
                        ctx.moveTo(trailPoint.x, trailPoint.y);
                    } else {
                        ctx.lineTo(trailPoint.x, trailPoint.y);
                    }
                });
                ctx.stroke();

                // Remove old trail points
                if (star.trail.length > 10) {
                    star.trail.shift();
                }

                // Remove star if it goes off screen
                if (star.x < 0 || star.y < 0 || star.x > window.innerWidth || star.y > window.innerHeight) {
                    shootingStars.splice(index, 1);
                }
            });
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas for new frame
            drawShootingStars();
            drawTrail();
            moveDots();
            requestAnimationFrame(animate);
        }

        function createDot(x, y) {
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.left = `${x}px`;
            dot.style.top = `${y}px`;
            dot.style.backgroundColor = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.5})`; // Random brightness
            document.body.appendChild(dot);
            dots.push({ element: dot, x, y, offsetX: Math.random() * 0.05 - 0.025, offsetY: Math.random() * 0.05 - 0.025 });
        }

        function moveDots() {
            dots.forEach(dot => {
                dot.x += dot.offsetX;
                dot.y += dot.offsetY;
                if (dot.x < 0 || dot.x > window.innerWidth) dot.offsetX *= -1;
                if (dot.y < 0 || dot.y > window.innerHeight) dot.offsetY *= -1;
                dot.element.style.left = `${dot.x}px`;
                dot.element.style.top = `${dot.y}px`;
            });
        }

        function createStar(x, y) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = `${x}px`;
            star.style.top = `${y}px`;
            star.style.backgroundImage = "url('Images/star.png')"; // Updated path
            star.style.backgroundSize = 'cover'; // Ensure the image covers the star
            star.style.width = '100px'; // Ensure size is consistent
            star.style.height = '100px';
            star.dataset.originalX = x;
            star.dataset.originalY = y;
            star.onclick = () => {
                playClickSound();
                incrementCoins(); // Call the function to increment coins
                showPopup();
            };
            star.onmouseover = () => playHoverSound();
            star.onmouseout = () => stopHoverSound();
            document.body.appendChild(star);
            stars.push(star);
        }

        async function incrementCoins() {
            const sessionId = localStorage.getItem('sessionId'); // Retrieve session ID
            console.log('Incrementing coins for session:', sessionId); // Log session ID
            try {
                const response = await fetch('http://localhost:3000/api/coins/increment', { // Ensure the URL matches your server's
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sessionId })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Coins updated:', data.coins);
            } catch (error) {
                console.error('Error updating coins:', error);
            }
        }

        function generateDots(count) {
            for (let i = 0; i < count; i++) {
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                createDot(x, y);
            }
        }

        function generateConstellations() {
            const constellations = [
                // Orion
                [{ x: 0.3, y: 0.4 }, { x: 0.35, y: 0.45 }, { x: 0.4, y: 0.4 }, { x: 0.45, y: 0.35 }, { x: 0.5, y: 0.4 }, { x: 0.55, y: 0.45 }, { x: 0.6, y: 0.4 }],
                // Big Dipper
                [{ x: 0.1, y: 0.2 }, { x: 0.15, y: 0.25 }, { x: 0.2, y: 0.3 }, { x: 0.25, y: 0.35 }, { x: 0.3, y: 0.4 }, { x: 0.35, y: 0.45 }, { x: 0.4, y: 0.5 }],
                // Cassiopeia
                [{ x: 0.7, y: 0.2 }, { x: 0.75, y: 0.25 }, { x: 0.8, y: 0.2 }, { x: 0.85, y: 0.25 }, { x: 0.9, y: 0.2 }]
            ];

            constellations.forEach(pattern => {
                pattern.forEach(point => {
                    createStar(point.x * window.innerWidth, point.y * window.innerHeight);
                });
            });
        }

        function moveElements(event) {
            trail.push({ x: event.clientX, y: event.clientY, time: Date.now() });
            const dots = document.querySelectorAll('.dot');
            dots.forEach(dot => {
                const rect = dot.getBoundingClientRect();
                const dotCenterX = rect.left + rect.width / 2;
                const dotCenterY = rect.top + rect.height / 2;
                const distance = Math.hypot(event.clientX - dotCenterX, event.clientY - dotCenterY);

                if (distance < 100) { // Move farther away for dots
                    const moveX = (dotCenterX - event.clientX) * 0.1;
                    const moveY = (dotCenterY - event.clientY) * 0.1;
                    dot.style.transform = `translate(${moveX}px, ${moveY}px)`;
                } else {
                    dot.style.transform = 'translate(0, 0)';
                }
            });

            stars.forEach(star => {
                const rect = star.getBoundingClientRect();
                const starCenterX = rect.left + rect.width / 2;
                const starCenterY = rect.top + rect.height / 2;
                const distance = Math.hypot(event.clientX - starCenterX, event.clientY - starCenterY);

                if (distance < 300) { // Increase avoidance distance
                    const moveX = (event.clientX - starCenterX) * 0.3; // More pronounced movement
                    const moveY = (event.clientY - starCenterY) * 0.3;
                    star.style.transform = `translate(${moveX}px, ${moveY}px)`;
                } else {
                    star.style.transform = 'translate(0, 0)';
                    star.style.left = `${star.dataset.originalX}px`;
                    star.style.top = `${star.dataset.originalY}px`;
                }
            });
        }

        function showPopup() {
            const popup = document.getElementById('popup');
            popup.classList.add('show');
        }

        function closePopup() {
            const popup = document.getElementById('popup');
            popup.classList.remove('show');
        }

        function playHoverSound() {
            const hoverSound = document.getElementById('hoverSound');
            hoverSound.play();
        }

        function stopHoverSound() {
            const hoverSound = document.getElementById('hoverSound');
            hoverSound.pause();
            hoverSound.currentTime = 0;
        }

        function playClickSound() {
            const clickSound = document.getElementById('clickSound');
            clickSound.play();
        }

        function playBackgroundMusic() {
            const backgroundMusic = document.getElementById('backgroundMusic');
            backgroundMusic.play();
        }

        function toggleMute() {
            const backgroundMusic = document.getElementById('backgroundMusic');
            isMuted = !isMuted;
            backgroundMusic.muted = isMuted;
            document.getElementById('muteToggle').classList.toggle('muted', isMuted);
        }

        function getSessionId() {
            let sessionId = localStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('sessionId', sessionId);
            }
            return sessionId;
        }

        const userId = getSessionId();

        window.onload = () => {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            generateDots(500); // More dots for a starry effect
            generateConstellations(); // Generate fixed constellations
            document.addEventListener('mousemove', moveElements);
            setInterval(createShootingStar, Math.random() * 1000 + 1000); // Create a shooting star every 1-2 seconds
            animate();
            playBackgroundMusic(); // Ensure background music plays on load
        };
    </script>
</body>
</html>
